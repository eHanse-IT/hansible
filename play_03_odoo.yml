# Dieses Playbook MUSS mit Python2 als ansible_interpreter
# ausgeführt werden! Also den command
#   ansible_python_interpreter=/usr/bin/python3
# im Inventory file weglassen! Ansonsten schlägt die Installation
# von psycopg2 (Python-Postgres-Adapter) fehl.

---
- name: Odoo installieren,
  hosts:
  - ehprod
  - ehtest
  - twprod
  - twtest
  - chrono123
  vars_files:  # Verweis auf verschlüsselte Pws
    - vars
    - vault
  vars:
    odoo_version: "{{ odoo_version }}"
    odoo_config_addons_path: " {{ odoo_config_addons_path }}"
    odoo_config_admin_passwd: "{{ odoo_config_superadmin_password }}"
    odoo_config_dbfilter: .*
    odoo_config_proxy_mode: False
    odoo_config_email_from: False
    odoo_config_limit_memory_hard: 4294967296
    odoo_config_limit_memory_soft: 671088640
    odoo_config_limit_time_cpu: 8192
    odoo_config_limit_time_real: 1000
    odoo_config_limit_time_real_cron: 3000    # >= 10.0
    odoo_config_list_db: False       #change by joerg on 07.03.2018
    odoo_config_log_level: info
    odoo_config_logfile: /var/log/odoo/odoo-server.log
    odoo_config_logrotate: True
    odoo_config_server_wide_modules: web,web_kanban,dbfilter_from_header,
    odoo_config_smtp_password: "{{ odoo_config_smtp_password }}"
    odoo_config_smtp_port: "{{ odoo_config_smtp_port }}"
    odoo_config_smtp_server: "{{ odoo_config_smtp_server }}"
    odoo_config_smtp_ssl: "{{ odoo_config_smtp_ssl }}"
    odoo_config_smtp_user: "{{ odoo_config_smtp_user }}"
    odoo_config_workers: 5
    odoo_config_xmlrpc: True                # <= 10.0
    odoo_config_xmlrpc_interface: ''        # <= 10.0
    odoo_config_xmlrpc_port: 8069           # <= 10.0
    odoo_config_xmlrpcs: True               # <= 8.0
    odoo_config_xmlrpcs_interface: ''       # <= 8.0
    odoo_config_xmlrpcs_port: 8071          # <= 8.0
    # TODO refactor variables to be in the host definitions!

  pre_tasks:
    - apt:
       name: "{{ item }}"
       update_cache: no
       state: present
      loop:
       - python3-pip            #vorab pip3 installieren
       - python-pip
       - postgresql             #vorab postgreql installieren
       - ttf-wqy-zenhei         #vorab chinesische Schrift installieren
       - ttf-wqy-microhei       #vorab chinesische Schrift installieren
       - python-setuptools
       - python3-setuptools
    - pip:
       name: XlsxWriter         # as per request by Manfred
       state: latest

    - locale_gen:
       name: de_DE.UTF-8
       state: present
    - locale_gen:
       name: en_US.UTF-8
       state: present
  roles:
   - ansible-odoo
  post_tasks:
   - git:
       repo: 'https://github.com/eHanse-IT/OAW_custom.git'
       dest: '/home/odoo/odoo/custom/OAW-custom'
       force: yes
       umask: '755'
   - git:
       repo: 'https://github.com/rfhk/awo-custom.git'
       dest: '/home/odoo/odoo/custom/awo-custom'
       force: yes
       umask: '755'
   - file:
       path: '/home/odoo/odoo/custom/'
       owner: "{{ odoo_user }}"
       group: "{{ odoo_user }}"
       mode: 0755
       recurse: yes


# TODO: user password encrypten vom odoo_user_passwd
# TODO https://docs.ansible.com/ansible/latest/reference_appendices/faq.html#how-do-i-generate-crypted-passwords-for-the-user-module
# TODO: nach der Installation von Odoo 11 muss man einmal restarten, damit der Server keinen Error 500 hat

# TODO: Postgresql tuning mit pgbadger, siehe Mails mit Yoshi vom 10.07.2016


# TODO godalko master odoo.conf:

#[options]
#addons_path = /home/odoo/odoo/server/addons,/home/odoo/odoo/custom/OAW-custom,/home/odoo/odoo/custom/awo-custom
#admin_passwd = diesisteingeheimesPW123#
#auto_reload = False
#csv_internal_sep = ,
#data_dir = /home/odoo/.local/share/Odoo
#db_host = False
#db_maxconn = 64
#db_name = godalko
#db_password = False
#db_port = False
#db_template = template1
#db_user = odoo
#dbfilter =
#debug_mode = False
#demo = {}
#email_from = False
#geoip_database = /usr/share/GeoIP/GeoLiteCity.dat
#import_partial =
#limit_memory_hard = 4294967296
#limit_memory_soft = 671088640
#limit_request = 8192
#limit_time_cpu = 8192
#limit_time_real = 1000
#list_db = False
#log_db = False
#log_db_lvl = warning
#log_handler = [':INFO']
#log_level = debug
#logfile = /var/log/odoo/odoo-server.log
#logrotate = True
#longpolling_port = 8072
#max_cron_threads = 2
#osv_memory_age_limit = 1.0
#osv_memory_count_limit = False
#pg_path = None
#pidfile = None
#proxy_mode = False
#reportgz = False
#secure_cert_file = server.cert
#secure_pkey_file = server.pkey
#server_wide_modules = web,web_kanban,
#smtp_password = somepassword
#smtp_port = 587
#smtp_server = somesmtpserver.com
#smtp_ssl = True
#smtp_user = erp@oawatches.net
#syslog = False
#test_commit = False
#test_enable = False
#test_file = False
#test_report_directory = False
#timezone = False
#translate_modules = ['all']
#unaccent = False
#without_demo = False
#workers = 5
#xmlrpc = True
#xmlrpc_interface =
#xmlrpc_port = 8069
#xmlrpcs = True
#xmlrpcs_interface =
#xmlrpcs_port = 8071



