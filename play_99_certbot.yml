---
# Diese Rolle installiert Let'sEncrypt-Zertifikate auf einem Apache-Server. Anschließend werden die vhost.Dateien
# in /etc/apache2/sites-available/... überprüft und es wird nachgeschaut, ob in allen vhost-Dateien auch die
# Verweise auf das entsprechende Zertifikat hinterlegt sind
#
# Voraussetzungen für diese Rolle:
# - es muss zu jedem übergebenen vhost (certbot_certs.domains) eine entsprechende *.conf Datei im /etc/apache2/...
# hinterlegt sein. Das muss über die anderen Roles sichergestellt sein!
#


- name: Certbot Zertifikate installieren,
  hosts:
    - ehprod
    - ehtest
    - twprod
    - twtest
    - chrono123
  vars_files:  # Verweis auf verschlüsselte Pws
    - vars
    - vault
  vars: []
  roles:
   - certbot

  post_tasks:
    - lineinfile:
        path: /etc/apache2/sites-available/{{ item }}.conf
        regexp: '^Include /etc/letsencrypt/'
        line:   'Include /etc/letsencrypt/options-ssl-apache.conf'
        state: present
        insertafter: '^<virtualhost \*:443>'
      with_items:
        - "{{ certbot_certs[0].domains }}"


    - lineinfile:
        path: /etc/apache2/sites-available/{{ item }}.conf
        regexp: '^SSLCertificateFile'
        line:   'SSLCertificateFile /etc/letsencrypt/live/{{ certbot_certs[0].domains[0] }}/fullchain.pem'
        state: present
        insertafter: '^Include /etc/letsencrypt'
      with_items:
        - "{{ certbot_certs[0].domains }}"



    - lineinfile:
        path: /etc/apache2/sites-available/{{ item }}.conf
        regexp: '^SSLCertificateKeyFile'
        line:   'SSLCertificateKeyFile /etc/letsencrypt/live/{{ certbot_certs[0].domains[0] }}/privkey.pem'
        state: present
        insertafter: '^SSLCertificateFile'
      with_items:
        - "{{ certbot_certs[0].domains }}"


    - service:
        name: apache2
        state: restarted

      # TODO: die Zeile nicht unbedingt neu generieren, falls schon vorhanden





  # TODO Vorsicht auf Ubuntu 18.04, pip hat eine Regression, siehe
  # TODO https://community.letsencrypt.org/t/certbot-has-problem-setting-up-the-virtual-environment/83678?page=2
  # TODO Also erstmal pip manuell auf dem Server auf die neueste Version bringen mit
  # TODO https://pip.pypa.io/en/stable/installing/
  # TODO


